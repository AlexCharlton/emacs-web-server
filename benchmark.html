<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Benchmark</title>
<!-- 2014-01-04 Sat 01:42 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<style>pre{background:#232323; color:#E6E1DC;} table{margin:auto} @media(min-width:800px){div#content{max-width:800px; padding:2em; margin:auto;}}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Benchmark</h1>
<p>
A quick and dirty comparison of <a href="https://github.com/eschulte/emacs-web-server">web-server</a> and <a href="https://github.com/nicferrier/elnode">elnode</a> runtime across
three levels of concurrency.  A simple GET request with a url-encoded
parameter is used for evaluation.  We send 5000 requests to each
webserver in parallel batches of varying size to each webserver and
time how long it takes for all responses to be answered.  Run on my
x220 laptop with two dual-core Intel i7 CPUs, using <a href="http://www.gnu.org/software/parallel/">GNU parallel</a> we
see the following results.
</p>

<table id="comparison" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption align="above"><span class="table-number">Table 1:</span> Runtime in seconds to serve 5,000 requests.</caption>

<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">concurrency</th>
<th scope="col" class="right">web-server</th>
<th scope="col" class="right">elnode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">40.513</td>
<td class="right">46.88325</td>
</tr>

<tr>
<td class="right">10</td>
<td class="right">24.5505</td>
<td class="right">32.250625</td>
</tr>

<tr>
<td class="right">500</td>
<td class="right">33.52825</td>
<td class="right">63.894625</td>
</tr>
</tbody>
</table>

<p>
Web-server is faster than Elnode at all levels (although I suppose
neither is particularly impressive), and the performance gain seems to
improve as concurrency increases.  The limit of 500 concurrent
requests is due to limits of the "parallel" utility on my laptop.
</p>


<div class="figure">
<p><img src="runtime-comparison.svg" alt="runtime-comparison.svg" />
</p>
</div>

<p>
Specifics on the <a href="#get-request">GET Request</a> and <a href="#evaluation">Evaluation</a> are given below.
</p>

<div id="outline-container-get-request" class="outline-2">
<h2 id="get-request"><a id="sec-1" name="sec-1"></a>GET Request</h2>
<div class="outline-text-2" id="text-get-request">
<p>
The server reads an integer from the GET parameter n, adds 1 to the
value of "n" and responds with the value of n+1.
</p>

<ul class="org-ul">
<li>Web Server
<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #7f7f7f;">(</span>ws-start
 '<span style="color: #7f7f7f;">(((</span><span style="color: #ad7fa8;">:GET</span> . <span style="color: #e9b96e;">"*"</span><span style="color: #7f7f7f;">)</span> .
    <span style="color: #7f7f7f;">(</span><span style="color: #b4fa70;">lambda</span> <span style="color: #7f7f7f;">(</span>request<span style="color: #7f7f7f;">)</span>
      <span style="color: #7f7f7f;">(</span><span style="color: #b4fa70;">with-slots</span> <span style="color: #7f7f7f;">(</span>process headers<span style="color: #7f7f7f;">)</span> request
        <span style="color: #7f7f7f;">(</span>ws-response-header process 200 '<span style="color: #7f7f7f;">(</span><span style="color: #e9b96e;">"Content-type"</span> . <span style="color: #e9b96e;">"text/plain"</span><span style="color: #7f7f7f;">))</span>
        <span style="color: #7f7f7f;">(</span>process-send-string process
          <span style="color: #7f7f7f;">(</span>int-to-string <span style="color: #7f7f7f;">(</span>+ 1 <span style="color: #7f7f7f;">(</span>string-to-int <span style="color: #7f7f7f;">(</span>cdr <span style="color: #7f7f7f;">(</span>assoc <span style="color: #e9b96e;">"n"</span> headers<span style="color: #7f7f7f;">))))))))))</span>
 9004<span style="color: #7f7f7f;">)</span>
</pre>
</div>
</li>

<li>Elnode
<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #7f7f7f;">(</span>elnode-start
 <span style="color: #7f7f7f;">(</span><span style="color: #b4fa70;">lambda</span> <span style="color: #7f7f7f;">(</span>httpcon<span style="color: #7f7f7f;">)</span>
   <span style="color: #7f7f7f;">(</span>elnode-http-start httpcon 200 '<span style="color: #7f7f7f;">(</span><span style="color: #e9b96e;">"Content-Type"</span> . <span style="color: #e9b96e;">"text/plain"</span><span style="color: #7f7f7f;">))</span>
   <span style="color: #7f7f7f;">(</span>elnode-http-return httpcon
     <span style="color: #7f7f7f;">(</span>int-to-string <span style="color: #7f7f7f;">(</span>+ 1 <span style="color: #7f7f7f;">(</span>string-to-int
                          <span style="color: #7f7f7f;">(</span>cdr <span style="color: #7f7f7f;">(</span>assoc <span style="color: #e9b96e;">"n"</span> <span style="color: #7f7f7f;">(</span>elnode-http-params httpcon<span style="color: #7f7f7f;">))))))))</span>
 <span style="color: #ad7fa8;">:port</span> 9005 <span style="color: #ad7fa8;">:host</span> <span style="color: #e9b96e;">"localhost"</span><span style="color: #7f7f7f;">)</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-evaluation" class="outline-2">
<h2 id="evaluation"><a id="sec-2" name="sec-2"></a>Evaluation</h2>
<div class="outline-text-2" id="text-evaluation">
</div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">The most parallelism</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #fce94f;">submit</span>(){
    local <span style="color: #fcaf3e;">port</span>=$<span style="color: #fcaf3e;">1</span>;
    <span style="color: #b4fa70;">for</span> i<span style="color: #b4fa70;"> in</span> {0..5000};<span style="color: #b4fa70;">do</span>
        <span style="color: #ad7fa8;">echo</span> <span style="color: #e9b96e;">"curl -s -G -d \"n=$i\" http://localhost:$port"</span>
    <span style="color: #b4fa70;">done</span>|parallel -j 500|sha1sum; }

<span style="color: #b4fa70;">for</span> j<span style="color: #b4fa70;"> in</span> {0..8};<span style="color: #b4fa70;">do</span>
    <span style="color: #ad7fa8;">echo</span> web server
    time submit 9004
    <span style="color: #ad7fa8;">echo</span> elnode
    time submit 9005
done2&gt;&amp;1|tee /tmp/output
</pre>
</div>

<p>
A little munging of the output from <code>/tmp/output</code>,
</p>

<div class="org-src-container">

<pre class="src src-sh">cat /tmp/output <span style="color: #e9b96e;">\</span>
    |grep -e <span style="color: #e9b96e;">"real\|web server\|elnode"</span> <span style="color: #e9b96e;">\</span>
    |tr <span style="color: #e9b96e;">'\n'</span> <span style="color: #e9b96e;">' '</span> <span style="color: #e9b96e;">\</span>
    |sed <span style="color: #e9b96e;">'s/web server/\nws/g;s/elnode/\nen/g;s/real//g'</span>
</pre>
</div>

<p>
yields the following.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">run</th>
<th scope="col" class="right">web-server</th>
<th scope="col" class="right">elnode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">26.459</td>
<td class="right">43.484</td>
</tr>

<tr>
<td class="right">2</td>
<td class="right">34.289</td>
<td class="right">78.984</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">29.860</td>
<td class="right">38.646</td>
</tr>

<tr>
<td class="right">4</td>
<td class="right">34.454</td>
<td class="right">40.742</td>
</tr>

<tr>
<td class="right">5</td>
<td class="right">35.710</td>
<td class="right">42.884</td>
</tr>

<tr>
<td class="right">6</td>
<td class="right">36.962</td>
<td class="right">89.897</td>
</tr>

<tr>
<td class="right">7</td>
<td class="right">39.397</td>
<td class="right">129.905</td>
</tr>

<tr>
<td class="right">8</td>
<td class="right">31.095</td>
<td class="right">46.615</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">mean</td>
<td class="right">33.52825 +/- 1.4746653</td>
<td class="right">63.894625 +/- 11.643012</td>
</tr>
</tbody>
</table>

<p>
My guess is that the added overhead for the elnode runs is due to the
increased logging and the overhead of the callback model of execution.
</p>

<p>
Twice the following <a href="#undo-warning">Undo warning thrown by elnode</a> was thrown during elnode service.
</p>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Run again with much less parallelism</h3>
<div class="outline-text-3" id="text-2-2">
<p>
With <code>parallel -j 10</code> instead of <code>parallel -j 500</code>.
</p>

<p>
The <a href="#undo-warning">Undo warning thrown by elnode</a> was thrown 3 times by elnode in this run.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">run</th>
<th scope="col" class="right">web-server</th>
<th scope="col" class="right">elnode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">18.366</td>
<td class="right">24.034</td>
</tr>

<tr>
<td class="right">2</td>
<td class="right">21.807</td>
<td class="right">30.930</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">23.589</td>
<td class="right">35.878</td>
</tr>

<tr>
<td class="right">4</td>
<td class="right">25.562</td>
<td class="right">33.244</td>
</tr>

<tr>
<td class="right">5</td>
<td class="right">25.882</td>
<td class="right">32.824</td>
</tr>

<tr>
<td class="right">6</td>
<td class="right">25.584</td>
<td class="right">33.210</td>
</tr>

<tr>
<td class="right">7</td>
<td class="right">28.852</td>
<td class="right">33.532</td>
</tr>

<tr>
<td class="right">8</td>
<td class="right">26.762</td>
<td class="right">34.353</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">mean</td>
<td class="right">24.5505 +/- 1.1492008</td>
<td class="right">32.250625 +/- 1.2727409</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Finally with no parallelism</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-sh"><span style="color: #fce94f;">submit</span>(){
    local <span style="color: #fcaf3e;">port</span>=$<span style="color: #fcaf3e;">1</span>;
    <span style="color: #b4fa70;">for</span> i<span style="color: #b4fa70;"> in</span> {0..5000};<span style="color: #b4fa70;">do</span>
        curl -s -G -d <span style="color: #e9b96e;">"n=$i"</span> http://localhost:$<span style="color: #fcaf3e;">port</span>
    <span style="color: #b4fa70;">done</span>|sha1sum; }

<span style="color: #b4fa70;">for</span> j<span style="color: #b4fa70;"> in</span> {0..7};<span style="color: #b4fa70;">do</span>
    <span style="color: #ad7fa8;">echo</span> web server
    time submit 9004
    <span style="color: #ad7fa8;">echo</span> elnode
    time submit 9005
<span style="color: #b4fa70;">done</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">run</th>
<th scope="col" class="right">web-server</th>
<th scope="col" class="right">elnode</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="right">39.896</td>
<td class="right">49.528</td>
</tr>

<tr>
<td class="right">2</td>
<td class="right">40.573</td>
<td class="right">46.410</td>
</tr>

<tr>
<td class="right">3</td>
<td class="right">40.460</td>
<td class="right">46.669</td>
</tr>

<tr>
<td class="right">4</td>
<td class="right">40.695</td>
<td class="right">46.226</td>
</tr>

<tr>
<td class="right">5</td>
<td class="right">40.587</td>
<td class="right">46.995</td>
</tr>

<tr>
<td class="right">6</td>
<td class="right">40.644</td>
<td class="right">46.506</td>
</tr>

<tr>
<td class="right">7</td>
<td class="right">40.807</td>
<td class="right">46.648</td>
</tr>

<tr>
<td class="right">8</td>
<td class="right">40.442</td>
<td class="right">46.084</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">mean</td>
<td class="right">40.513 +/- 0.097681699</td>
<td class="right">46.88325 +/- 0.39063816</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-undo-warning" class="outline-3">
<h3 id="undo-warning"><a id="sec-2-4" name="sec-2-4"></a>Undo warning thrown by elnode</h3>
<div class="outline-text-3" id="text-undo-warning">
<pre class="example">
Warning (undo): Buffer `*elnode-server-error*' undo info was 30181148 bytes long.
The undo info was discarded because it exceeded `undo-outer-limit'.

This is normal if you executed a command that made a huge change
to the buffer.  In that case, to prevent similar problems in the
future, set `undo-outer-limit' to a value that is large enough to
cover the maximum size of normal changes you expect a single
command to make, but not so large that it might exceed the
maximum memory allotted to Emacs.

If you did not execute any such command, the situation is
probably due to a bug and you should report it.

You can disable the popping up of this buffer by adding the entry
(undo discard-info) to the user option `warning-suppress-types',
which is defined in the `warnings' library.
</pre>

<p>
This should be fairly easy to fix.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2014-01-04 Sat 01:42</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.4)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
